var flowy=function(e,t,i,l,r,d){function o(e,t,i){return l(e,t,i)}t||(t=function(){}),i||(i=function(){}),l||(l=function(){return!0}),r||(r=20),d||(d=80),$(document).ready(function(){var l,a,f,n,s,p,c=[],h=[],v=e,u=!1,w=r,g=d,x=0,b=0,k=!1,m=!1;function y(e,t,i){k||e.appendTo(v);for(var l=0,r=0,d=0;d<c.filter(e=>e.parent==i[t]).length;d++){(u=c.filter(e=>e.parent==i[t])[d]).childwidth>u.width?l+=u.childwidth+w:l+=u.width+w}l+=e.innerWidth();for(d=0;d<c.filter(e=>e.parent==i[t]).length;d++){(u=c.filter(e=>e.parent==i[t])[d]).childwidth>u.width?($(".blockid[value="+u.id+"]").parent().css("left",c.filter(e=>e.id==i[t])[0].x-l/2+r+u.childwidth/2-u.width/2+"px"),u.x=c.filter(e=>e.parent==i[t])[0].x-l/2+r+u.childwidth/2,r+=u.childwidth+w):($(".blockid[value="+u.id+"]").parent().css("left",c.filter(e=>e.id==i[t])[0].x-l/2+r+"px"),u.x=c.filter(e=>e.parent==i[t])[0].x-l/2+r+u.width/2,r+=u.width+w)}if(e.css("left",c.filter(e=>e.id==i[t])[0].x-l/2+r-v.offset().left+v.scrollLeft()+"px"),e.css("top",c.filter(e=>e.id==i[t])[0].y+c.filter(e=>e.id==i[t])[0].height/2+g-v.offset().top+"px"),k){h.filter(t=>t.id==parseInt(e.children(".blockid").val()))[0].x=e.offset().left+e.innerWidth()/2+v.scrollLeft()+v.scrollLeft(),h.filter(t=>t.id==parseInt(e.children(".blockid").val()))[0].y=e.offset().top+e.innerHeight()/2+v.scrollTop(),h.filter(t=>t.id==e.children(".blockid").val())[0].parent=i[t];for(d=0;d<h.length;d++)h[d].id!=parseInt(e.children(".blockid").val())&&($(".blockid[value="+h[d].id+"]").parent().css("left",$(".blockid[value="+h[d].id+"]").parent().offset().left-v.offset().left+v.scrollLeft()),$(".blockid[value="+h[d].id+"]").parent().css("top",$(".blockid[value="+h[d].id+"]").parent().offset().top-v.offset().top+v.scrollTop()),$(".arrowid[value="+h[d].id+"]").parent().css("left",$(".arrowid[value="+h[d].id+"]").parent().offset().left-v.offset().left+v.scrollLeft()+20),$(".arrowid[value="+h[d].id+"]").parent().css("top",$(".arrowid[value="+h[d].id+"]").parent().offset().top-v.offset().top+v.scrollTop()),$(".blockid[value="+h[d].id+"]").parent().appendTo(v),$(".arrowid[value="+h[d].id+"]").parent().appendTo(v),h[d].x=$(".blockid[value="+h[d].id+"]").parent().offset().left+$(".blockid[value="+h[d].id+"]").innerWidth()/2+v.scrollLeft(),h[d].y=$(".blockid[value="+h[d].id+"]").parent().offset().top+$(".blockid[value="+h[d].id+"]").parent().innerHeight()/2+v.scrollTop());c=$.merge(c,h),h=[]}else c.push({childwidth:0,parent:i[t],id:parseInt(e.children(".blockid").val()),x:e.offset().left+e.innerWidth()/2+v.scrollLeft(),y:e.offset().top+e.innerHeight()/2+v.scrollTop(),width:e.innerWidth(),height:e.innerHeight()});var o=c.filter(t=>t.id==parseInt(e.children(".blockid").val()))[0],a=o.x-c.filter(e=>e.id==i[t])[0].x+20,f=o.y-o.height/2-(c.filter(e=>e.parent==i[t])[0].y+c.filter(e=>e.parent==i[t])[0].height/2)+v.scrollTop();if(a<0?(e.after('<div class="arrowblock"><input type="hidden" class="arrowid" value="'+e.children(".blockid").val()+'"><svg preserveaspectratio="none" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M'+(c.filter(e=>e.id==i[t])[0].x-o.x+5)+" 0L"+(c.filter(e=>e.id==i[t])[0].x-o.x+5)+" "+g/2+"L5 "+g/2+"L5 "+f+'" stroke="#C5CCD0" stroke-width="2px"/><path d="M0 '+(f-5)+"H10L5 "+f+"L0 "+(f-5)+'Z" fill="#C5CCD0"/></svg></div>'),$(".arrowid[value="+e.children(".blockid").val()+"]").parent().css("left",o.x-5-v.offset().left+v.scrollLeft()+"px")):(e.after('<div class="arrowblock"><input type="hidden" class="arrowid" value="'+e.children(".blockid").val()+'"><svg preserveaspectratio="none" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 0L20 '+g/2+"L"+a+" "+g/2+"L"+a+" "+f+'" stroke="#C5CCD0" stroke-width="2px"/><path d="M'+(a-5)+" "+(f-5)+"H"+(a+5)+"L"+a+" "+f+"L"+(a-5)+" "+(f-5)+'Z" fill="#C5CCD0"/></svg></div>'),$(".arrowid[value="+parseInt(e.children(".blockid").val())+"]").parent().css("left",c.filter(e=>e.id==i[t])[0].x-20-v.offset().left+v.scrollLeft()+"px")),$(".arrowid[value="+parseInt(e.children(".blockid").val())+"]").parent().css("top",c.filter(e=>e.id==i[t])[0].y+c.filter(e=>e.id==i[t])[0].height/2+"px"),-1!=c.filter(e=>e.id==i[t])[0].parent){for(var n=!1,s=i[t];!n;)if(-1==c.filter(e=>e.id==s)[0].parent)n=!0;else{var p=0;for(d=0;d<c.filter(e=>e.parent==s).length;d++){var u;(u=c.filter(e=>e.parent==s)[d]).childwidth>u.width?d==c.filter(e=>e.parent==s).length-1?p+=u.childwidth:p+=u.childwidth+w:d==c.filter(e=>e.parent==s).length-1?p+=u.width:p+=u.width+w}c.filter(e=>e.id==s)[0].childwidth=p,s=c.filter(e=>e.id==s)[0].parent}c.filter(e=>e.id==s)[0].childwidth=l}k&&(k=!1,e.removeClass("dragging")),C(),function(){x=c.map(e=>e.x);var e=c.map(e=>e.width),t=x.map(function(t,i){return t-e[i]/2});if((x=Math.min.apply(Math,t))<v.offset().left){m=!0;for(var i=c.map(e=>e.id),l=0;l<c.length;l++)if($(".blockid[value="+c.filter(e=>e.id==i[l])[0].id+"]").parent().css("left",c.filter(e=>e.id==i[l])[0].x-c.filter(e=>e.id==i[l])[0].width/2-x+20),-1!=c.filter(e=>e.id==i[l])[0].parent){var r=c.filter(e=>e.id==i[l])[0],d=r.x-c.filter(e=>e.id==c.filter(e=>e.id==i[l])[0].parent)[0].x;d<0?$(".arrowid[value="+i[l]+"]").parent().css("left",r.x-x+20-5+"px"):$(".arrowid[value="+i[l]+"]").parent().css("left",c.filter(e=>e.id==c.filter(e=>e.id==i[l])[0].parent)[0].x-20-x+20+"px")}for(var l=0;l<c.length;l++)c[l].x=$(".blockid[value="+c[l].id+"]").parent().offset().left+v.offset().left-$(".blockid[value="+c[l].id+"]").parent().innerWidth()/2-40;b=x}}()}function C(){for(var e=c.map(e=>e.parent),t=0;t<e.length;t++){-1==e[t]&&t++;for(var i=0,l=0,r=0;r<c.filter(i=>i.parent==e[t]).length;r++){var d=c.filter(i=>i.parent==e[t])[r];0==c.filter(e=>e.parent==d.id).length&&(d.childwidth=0),d.childwidth>d.width?r==c.filter(i=>i.parent==e[t]).length-1?i+=d.childwidth:i+=d.childwidth+w:r==c.filter(i=>i.parent==e[t]).length-1?i+=d.width:i+=d.width+w}-1!=e[t]&&(c.filter(i=>i.id==e[t])[0].childwidth=i);for(r=0;r<c.filter(i=>i.parent==e[t]).length;r++){d=c.filter(i=>i.parent==e[t])[r];$(".blockid[value="+d.id+"]").parent().css("top",c.filter(i=>i.id==e[t]).y+g+"px"),c.filter(i=>i.id==e[t]).y=c.filter(i=>i.id==e[t]).y+g,d.childwidth>d.width?($(".blockid[value="+d.id+"]").parent().css("left",c.filter(i=>i.id==e[t])[0].x-i/2+l+d.childwidth/2-d.width/2-v.offset().left+"px"),d.x=c.filter(i=>i.id==e[t])[0].x-i/2+l+d.childwidth/2,l+=d.childwidth+w):($(".blockid[value="+d.id+"]").parent().css("left",c.filter(i=>i.id==e[t])[0].x-i/2+l-v.offset().left+"px"),d.x=c.filter(i=>i.id==e[t])[0].x-i/2+l+d.width/2,l+=d.width+w);var o=c.filter(e=>e.id==d.id)[0],a=o.x-c.filter(e=>e.id==d.parent)[0].x+20,f=o.y-o.height/2-(c.filter(e=>e.id==d.parent)[0].y+c.filter(e=>e.id==d.parent)[0].height/2);$(".arrowid[value="+d.id+"]").parent().css("top",c.filter(e=>e.id==d.parent)[0].y+c.filter(e=>e.id==d.parent)[0].height/2-v.offset().top+"px"),a<0?($(".arrowid[value="+d.id+"]").parent().css("left",o.x-5-v.offset().left+"px"),$(".arrowid[value="+d.id+"]").parent().html('<input type="hidden" class="arrowid" value="'+d.id+'"><svg preserveaspectratio="none" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M'+(c.filter(e=>e.id==d.parent)[0].x-o.x+5)+" 0L"+(c.filter(e=>e.id==d.parent)[0].x-o.x+5)+" "+g/2+"L5 "+g/2+"L5 "+f+'" stroke="#C5CCD0" stroke-width="2px"/><path d="M0 '+(f-5)+"H10L5 "+f+"L0 "+(f-5)+'Z" fill="#C5CCD0"/></svg>')):($(".arrowid[value="+d.id+"]").parent().css("left",c.filter(e=>e.id==d.parent)[0].x-20-v.offset().left+"px"),$(".arrowid[value="+d.id+"]").parent().html('<input type="hidden" class="arrowid" value="'+d.id+'"><svg preserveaspectratio="none" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 0L20 '+g/2+"L"+a+" "+g/2+"L"+a+" "+f+'" stroke="#C5CCD0" stroke-width="2px"/><path d="M'+(a-5)+" "+(f-5)+"H"+(a+5)+"L"+a+" "+f+"L"+(a-5)+" "+(f-5)+'Z" fill="#C5CCD0"/></svg>'))}}}v.append("<div class='indicator invisible'></div>"),flowy.import=function(e){v.html(JSON.parse(e.html)),c=e.blockarr},flowy.output=function(){var e={html:JSON.stringify(v.html()),blockarr:c,blocks:[]};if(c.length>0){for(var t=0;t<c.length;t++)e.blocks.push({id:c[t].id,parent:c[t].parent,data:[],attr:[]}),$(".blockid[value="+c[t].id+"]").parent().find("input").each(function(){var i=$(this).attr("name"),l=$(this).val();e.blocks[t].data.push({name:i,value:l})}),$.each($(".blockid[value="+c[t].id+"]").parent()[0].attributes,function(i,l){var r={};r[l.name]=l.value,e.blocks[t].attr.push(r)});return e}},flowy.deleteBlocks=function(){c=[],v.html("<div class='indicator invisible'></div>")},$(document).on("mousedown touchstart",".create-flowy",function(e){var i;e.targetTouches?(s=e.changedTouches[0].clientX,p=e.changedTouches[0].clientY):(s=e.clientX,p=e.clientY),3!=e.which&&(n=$(this),0==c.length?($(this).clone().addClass("block").append("<input type='hidden' name='blockid' class='blockid' value='"+c.length+"'>").removeClass("create-flowy").appendTo("body"),$(this).addClass("dragnow"),l=$(".blockid[value="+c.length+"]").parent()):($(this).clone().addClass("block").append("<input type='hidden' name='blockid' class='blockid' value='"+(Math.max.apply(Math,c.map(e=>e.id))+1)+"'>").removeClass("create-flowy").appendTo("body"),$(this).addClass("dragnow"),l=$(".blockid[value="+(parseInt(Math.max.apply(Math,c.map(e=>e.id)))+1)+"]").parent()),i=$(this),t(i),l.addClass("dragging"),u=!0,a=s-$(this).offset().left,f=p-$(this).offset().top,l.css("left",s-a+"px"),l.css("top",p-f+"px"))}),$(document).on("mouseup touchend",function(e){if(3!=e.which&&(u||k))if(i(),$(".indicator").hasClass("invisible")||$(".indicator").addClass("invisible"),u&&(n.removeClass("dragnow"),l.removeClass("dragging")),0==parseInt(l.children(".blockid").val())&&k){l.removeClass("dragging"),k=!1;for(var t=0;t<h.length;t++)h[t].id!=parseInt(l.children(".blockid").val())&&($(".blockid[value="+h[t].id+"]").parent().css("left",$(".blockid[value="+h[t].id+"]").parent().offset().left-v.offset().left+v.scrollLeft()),$(".blockid[value="+h[t].id+"]").parent().css("top",$(".blockid[value="+h[t].id+"]").parent().offset().top-v.offset().top+v.scrollTop()),$(".arrowid[value="+h[t].id+"]").parent().css("left",$(".arrowid[value="+h[t].id+"]").parent().offset().left-v.offset().left+v.scrollLeft()),$(".arrowid[value="+h[t].id+"]").parent().css("top",$(".arrowid[value="+h[t].id+"]").parent().offset().top-v.offset().top+v.scrollTop()+"px"),$(".blockid[value="+h[t].id+"]").parent().appendTo(v),$(".arrowid[value="+h[t].id+"]").parent().appendTo(v),h[t].x=$(".blockid[value="+h[t].id+"]").parent().offset().left+$(".blockid[value="+h[t].id+"]").innerWidth()/2+v.scrollLeft(),h[t].y=$(".blockid[value="+h[t].id+"]").parent().offset().top+$(".blockid[value="+h[t].id+"]").parent().innerHeight()/2+v.scrollTop());h.filter(e=>0==e.id)[0].x=l.offset().left+l.innerWidth()/2,h.filter(e=>0==e.id)[0].y=l.offset().top+l.innerHeight()/2,c=$.merge(c,h),h=[]}else if(u&&0==c.length&&l.offset().top>v.offset().top&&l.offset().left>v.offset().left)o(l,!0,void 0),u=!1,l.css("top",l.offset().top-v.offset().top+v.scrollTop()+"px"),l.css("left",l.offset().left-v.offset().left+v.scrollLeft()+"px"),l.appendTo(v),c.push({parent:-1,childwidth:0,id:parseInt(l.children(".blockid").val()),x:l.offset().left+l.innerWidth()/2+v.scrollLeft(),y:l.offset().top+l.innerHeight()/2+v.scrollTop(),width:l.innerWidth(),height:l.innerHeight()});else if(u&&0==c.length)l.remove();else if(u||k)for(var r=l.offset().left+l.innerWidth()/2+v.scrollLeft(),d=l.offset().top+v.scrollTop(),a=c.map(e=>e.id),f=0;f<c.length;f++){if(r>=c.filter(e=>e.id==a[f])[0].x-c.filter(e=>e.id==a[f])[0].width/2-w&&r<=c.filter(e=>e.id==a[f])[0].x+c.filter(e=>e.id==a[f])[0].width/2+w&&d>=c.filter(e=>e.id==a[f])[0].y-c.filter(e=>e.id==a[f])[0].height/2&&d<=c.filter(e=>e.id==a[f])[0].y+c.filter(e=>e.id==a[f])[0].height){u=!1,!k&&o(l,!1,c.filter(e=>e.id==a[f])[0])?y(l,f,a):k&&y(l,f,a);break}f==c.length-1&&(k&&(k=!1,h=[]),u=!1,l.remove())}}),$(document).on("mousedown touchstart",".block",function(e){$(document).on("mouseup mousemove touchmove",".block",function e(t){if(t.targetTouches?(s=t.targetTouches[0].clientX,p=t.targetTouches[0].clientY):(s=t.clientX,p=t.clientY),"mouseup"!==t.type&&3!=t.which&&!u&&!k){k=!0,(l=$(this)).addClass("dragging"),a=s-$(this).offset().left,f=p-$(this).offset().top;var i=parseInt($(this).children(".blockid").val());l=$(this),h.push(c.filter(e=>e.id==i)[0]),c=$.grep(c,function(e){return e.id!=i}),$(".arrowid[value="+i+"]").parent().remove();for(var r=c.filter(e=>e.parent==i),d=!1,o=[],n=[];!d;){for(var w=0;w<r.length;w++)h.push(c.filter(e=>e.id==r[w].id)[0]),$(".blockid[value="+r[w].id+"]").parent().css("left",$(".blockid[value="+r[w].id+"]").parent().offset().left-l.offset().left),$(".blockid[value="+r[w].id+"]").parent().css("top",$(".blockid[value="+r[w].id+"]").parent().offset().top-l.offset().top),$(".arrowid[value="+r[w].id+"]").parent().css("left",$(".arrowid[value="+r[w].id+"]").parent().offset().left-l.offset().left),$(".arrowid[value="+r[w].id+"]").parent().css("top",$(".arrowid[value="+r[w].id+"]").parent().offset().top-l.offset().top),$(".blockid[value="+r[w].id+"]").parent().appendTo(l),$(".arrowid[value="+r[w].id+"]").parent().appendTo(l),o.push(r[w].id),n.push(r[w].id);0==o.length?d=!0:(r=c.filter(e=>o.includes(e.parent)),o=[])}for(w=0;w<c.filter(e=>e.parent==i).length;w++){var g=c.filter(e=>e.parent==i)[w];c=$.grep(c,function(e){return e.id!=g})}for(w=0;w<n.length;w++){g=n[w];c=$.grep(c,function(e){return e.id!=g})}c.length>1&&C(),m&&function(){if(b<v.offset().left){m=!1;for(var e=c.map(e=>e.id),t=0;t<c.length;t++)if($(".blockid[value="+c.filter(i=>i.id==e[t])[0].id+"]").parent().css("left",c.filter(i=>i.id==e[t])[0].x-c.filter(i=>i.id==e[t])[0].width/2-b-20),c.filter(i=>i.id==e[t])[0].x=$(".blockid[value="+c.filter(i=>i.id==e[t])[0].id+"]").parent().offset().left+c.filter(i=>i.id==e[t])[0].width/2,-1!=c.filter(i=>i.id==e[t])[0].parent){var i=c.filter(i=>i.id==e[t])[0],l=i.x-c.filter(i=>i.id==c.filter(i=>i.id==e[t])[0].parent)[0].x;l<0?$(".arrowid[value="+e[t]+"]").parent().css("left",i.x-5-v.offset().left+"px"):$(".arrowid[value="+e[t]+"]").parent().css("left",c.filter(i=>i.id==c.filter(i=>i.id==e[t])[0].parent)[0].x-20-v.offset().left+"px")}for(var t=0;t<c.length;t++);b=0}}()}$(document).off("mouseup mousemove touchmove",e)})}),$(document).on("mousemove touchmove",function(e){if(e.targetTouches?(s=e.targetTouches[0].clientX,p=e.targetTouches[0].clientY):(s=e.clientX,p=e.clientY),u?(l.css("left",s-a+"px"),l.css("top",p-f+"px")):k&&(l.css("left",s-a-v.offset().left+v.scrollLeft()+"px"),l.css("top",p-f-v.offset().top+v.scrollTop()+"px"),h.filter(e=>e.id==parseInt(l.children(".blockid").val())).x=l.offset().left+l.innerWidth()/2+v.scrollLeft(),h.filter(e=>e.id==parseInt(l.children(".blockid").val())).y=l.offset().left+l.innerHeight()/2+v.scrollTop()),u||k)for(var t=l.offset().left+l.innerWidth()/2+v.scrollLeft(),i=l.offset().top+v.scrollTop(),r=c.map(e=>e.id),d=0;d<c.length;d++){if(t>=c.filter(e=>e.id==r[d])[0].x-c.filter(e=>e.id==r[d])[0].width/2-w&&t<=c.filter(e=>e.id==r[d])[0].x+c.filter(e=>e.id==r[d])[0].width/2+w&&i>=c.filter(e=>e.id==r[d])[0].y-c.filter(e=>e.id==r[d])[0].height/2&&i<=c.filter(e=>e.id==r[d])[0].y+c.filter(e=>e.id==r[d])[0].height){$(".indicator").appendTo($(".blockid[value="+r[d]+"]").parent()),$(".indicator").css("left",$(".blockid[value="+r[d]+"]").parent().innerWidth()/2-5+"px"),$(".indicator").css("top",$(".blockid[value="+r[d]+"]").parent().innerHeight()+"px"),$(".indicator").removeClass("invisible");break}d==c.length-1&&($(".indicator").hasClass("invisible")||$(".indicator").addClass("invisible"))}})})};