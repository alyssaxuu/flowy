var flowy=function(e,t,i,l,r,d){function f(e,t){return l(e,t)}t||(t=function(){}),i||(i=function(){}),l||(l=function(){return!0}),r||(r=20),d||(d=80),$(document).ready(function(){var l,o,a,n,s=[],p=[],c=e,h=!1,v=r,u=d,w=0,g=0,x=!1,b=!1;function k(e,t,i){x||e.appendTo(c);for(var l=0,r=0,d=0;d<s.filter(e=>e.parent==i[t]).length;d++){(y=s.filter(e=>e.parent==i[t])[d]).childwidth>y.width?l+=y.childwidth+v:l+=y.width+v}l+=e.innerWidth();for(d=0;d<s.filter(e=>e.parent==i[t]).length;d++){(y=s.filter(e=>e.parent==i[t])[d]).childwidth>y.width?($(".blockid[value="+y.id+"]").parent().css("left",s.filter(e=>e.id==i[t])[0].x-l/2+r+y.childwidth/2-y.width/2+"px"),y.x=s.filter(e=>e.parent==i[t])[0].x-l/2+r+y.childwidth/2,r+=y.childwidth+v):($(".blockid[value="+y.id+"]").parent().css("left",s.filter(e=>e.id==i[t])[0].x-l/2+r+"px"),y.x=s.filter(e=>e.parent==i[t])[0].x-l/2+r+y.width/2,r+=y.width+v)}if(e.css("left",s.filter(e=>e.id==i[t])[0].x-l/2+r-c.offset().left+c.scrollLeft()+"px"),e.css("top",s.filter(e=>e.id==i[t])[0].y+s.filter(e=>e.id==i[t])[0].height/2+u-c.offset().top+"px"),x){p.filter(t=>t.id==parseInt(e.children(".blockid").val()))[0].x=e.offset().left+e.innerWidth()/2+c.scrollLeft()+c.scrollLeft(),p.filter(t=>t.id==parseInt(e.children(".blockid").val()))[0].y=e.offset().top+e.innerHeight()/2+c.scrollTop(),p.filter(t=>t.id==e.children(".blockid").val())[0].parent=i[t];for(d=0;d<p.length;d++)p[d].id!=parseInt(e.children(".blockid").val())&&($(".blockid[value="+p[d].id+"]").parent().css("left",$(".blockid[value="+p[d].id+"]").parent().offset().left-c.offset().left+c.scrollLeft()),$(".blockid[value="+p[d].id+"]").parent().css("top",$(".blockid[value="+p[d].id+"]").parent().offset().top-c.offset().top+c.scrollTop()),$(".arrowid[value="+p[d].id+"]").parent().css("left",$(".arrowid[value="+p[d].id+"]").parent().offset().left-c.offset().left+c.scrollLeft()+20),$(".arrowid[value="+p[d].id+"]").parent().css("top",$(".arrowid[value="+p[d].id+"]").parent().offset().top-c.offset().top+c.scrollTop()),$(".blockid[value="+p[d].id+"]").parent().appendTo(c),$(".arrowid[value="+p[d].id+"]").parent().appendTo(c),p[d].x=$(".blockid[value="+p[d].id+"]").parent().offset().left+$(".blockid[value="+p[d].id+"]").innerWidth()/2+c.scrollLeft(),p[d].y=$(".blockid[value="+p[d].id+"]").parent().offset().top+$(".blockid[value="+p[d].id+"]").parent().innerHeight()/2+c.scrollTop());s=$.merge(s,p),p=[]}else s.push({childwidth:0,parent:i[t],id:parseInt(e.children(".blockid").val()),x:e.offset().left+e.innerWidth()/2+c.scrollLeft(),y:e.offset().top+e.innerHeight()/2+c.scrollTop(),width:e.innerWidth(),height:e.innerHeight()});var f=s.filter(t=>t.id==parseInt(e.children(".blockid").val()))[0],o=f.x-s.filter(e=>e.id==i[t])[0].x+20,a=f.y-f.height/2-(s.filter(e=>e.parent==i[t])[0].y+s.filter(e=>e.parent==i[t])[0].height/2)+c.scrollTop();if(o<0?(e.after('<div class="arrowblock"><input type="hidden" class="arrowid" value="'+e.children(".blockid").val()+'"><svg preserveaspectratio="none" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M'+(s.filter(e=>e.id==i[t])[0].x-f.x+5)+" 0L"+(s.filter(e=>e.id==i[t])[0].x-f.x+5)+" "+u/2+"L5 "+u/2+"L5 "+a+'" stroke="#C5CCD0" stroke-width="2px"/><path d="M0 '+(a-5)+"H10L5 "+a+"L0 "+(a-5)+'Z" fill="#C5CCD0"/></svg></div>'),$(".arrowid[value="+e.children(".blockid").val()+"]").parent().css("left",f.x-5-c.offset().left+c.scrollLeft()+"px")):(e.after('<div class="arrowblock"><input type="hidden" class="arrowid" value="'+e.children(".blockid").val()+'"><svg preserveaspectratio="none" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 0L20 '+u/2+"L"+o+" "+u/2+"L"+o+" "+a+'" stroke="#C5CCD0" stroke-width="2px"/><path d="M'+(o-5)+" "+(a-5)+"H"+(o+5)+"L"+o+" "+a+"L"+(o-5)+" "+(a-5)+'Z" fill="#C5CCD0"/></svg></div>'),$(".arrowid[value="+parseInt(e.children(".blockid").val())+"]").parent().css("left",s.filter(e=>e.id==i[t])[0].x-20-c.offset().left+c.scrollLeft()+"px")),$(".arrowid[value="+parseInt(e.children(".blockid").val())+"]").parent().css("top",s.filter(e=>e.id==i[t])[0].y+s.filter(e=>e.id==i[t])[0].height/2+"px"),-1!=s.filter(e=>e.id==i[t])[0].parent){for(var n=!1,h=i[t];!n;)if(-1==s.filter(e=>e.id==h)[0].parent)n=!0;else{var k=0;for(d=0;d<s.filter(e=>e.parent==h).length;d++){var y;(y=s.filter(e=>e.parent==h)[d]).childwidth>y.width?d==s.filter(e=>e.parent==h).length-1?k+=y.childwidth:k+=y.childwidth+v:d==s.filter(e=>e.parent==h).length-1?k+=y.width:k+=y.width+v}s.filter(e=>e.id==h)[0].childwidth=k,h=s.filter(e=>e.id==h)[0].parent}s.filter(e=>e.id==h)[0].childwidth=l}x&&(x=!1,e.removeClass("dragging")),m(),function(){w=s.map(e=>e.x);var e=s.map(e=>e.width),t=w.map(function(t,i){return t-e[i]/2});if((w=Math.min.apply(Math,t))<c.offset().left){b=!0;for(var i=s.map(e=>e.id),l=0;l<s.length;l++)if($(".blockid[value="+s.filter(e=>e.id==i[l])[0].id+"]").parent().css("left",s.filter(e=>e.id==i[l])[0].x-s.filter(e=>e.id==i[l])[0].width/2-w+20),-1!=s.filter(e=>e.id==i[l])[0].parent){var r=s.filter(e=>e.id==i[l])[0],d=r.x-s.filter(e=>e.id==s.filter(e=>e.id==i[l])[0].parent)[0].x;d<0?$(".arrowid[value="+i[l]+"]").parent().css("left",r.x-w+20-5+"px"):$(".arrowid[value="+i[l]+"]").parent().css("left",s.filter(e=>e.id==s.filter(e=>e.id==i[l])[0].parent)[0].x-20-w+20+"px")}for(var l=0;l<s.length;l++)s[l].x=$(".blockid[value="+s[l].id+"]").parent().offset().left+c.offset().left-$(".blockid[value="+s[l].id+"]").parent().innerWidth()/2-40;g=w}}()}function m(){for(var e=s.map(e=>e.parent),t=0;t<e.length;t++){-1==e[t]&&t++;for(var i=0,l=0,r=0;r<s.filter(i=>i.parent==e[t]).length;r++){var d=s.filter(i=>i.parent==e[t])[r];0==s.filter(e=>e.parent==d.id).length&&(d.childwidth=0),d.childwidth>d.width?r==s.filter(i=>i.parent==e[t]).length-1?i+=d.childwidth:i+=d.childwidth+v:r==s.filter(i=>i.parent==e[t]).length-1?i+=d.width:i+=d.width+v}-1!=e[t]&&(s.filter(i=>i.id==e[t])[0].childwidth=i);for(r=0;r<s.filter(i=>i.parent==e[t]).length;r++){d=s.filter(i=>i.parent==e[t])[r];$(".blockid[value="+d.id+"]").parent().css("top",s.filter(i=>i.id==e[t]).y+u+"px"),s.filter(i=>i.id==e[t]).y=s.filter(i=>i.id==e[t]).y+u,d.childwidth>d.width?($(".blockid[value="+d.id+"]").parent().css("left",s.filter(i=>i.id==e[t])[0].x-i/2+l+d.childwidth/2-d.width/2-c.offset().left+"px"),d.x=s.filter(i=>i.id==e[t])[0].x-i/2+l+d.childwidth/2,l+=d.childwidth+v):($(".blockid[value="+d.id+"]").parent().css("left",s.filter(i=>i.id==e[t])[0].x-i/2+l-c.offset().left+"px"),d.x=s.filter(i=>i.id==e[t])[0].x-i/2+l+d.width/2,l+=d.width+v);var f=s.filter(e=>e.id==d.id)[0],o=f.x-s.filter(e=>e.id==d.parent)[0].x+20,a=f.y-f.height/2-(s.filter(e=>e.id==d.parent)[0].y+s.filter(e=>e.id==d.parent)[0].height/2);$(".arrowid[value="+d.id+"]").parent().css("top",s.filter(e=>e.id==d.parent)[0].y+s.filter(e=>e.id==d.parent)[0].height/2-c.offset().top+"px"),o<0?($(".arrowid[value="+d.id+"]").parent().css("left",f.x-5-c.offset().left+"px"),$(".arrowid[value="+d.id+"]").parent().html('<input type="hidden" class="arrowid" value="'+d.id+'"><svg preserveaspectratio="none" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M'+(s.filter(e=>e.id==d.parent)[0].x-f.x+5)+" 0L"+(s.filter(e=>e.id==d.parent)[0].x-f.x+5)+" "+u/2+"L5 "+u/2+"L5 "+a+'" stroke="#C5CCD0" stroke-width="2px"/><path d="M0 '+(a-5)+"H10L5 "+a+"L0 "+(a-5)+'Z" fill="#C5CCD0"/></svg>')):($(".arrowid[value="+d.id+"]").parent().css("left",s.filter(e=>e.id==d.parent)[0].x-20-c.offset().left+"px"),$(".arrowid[value="+d.id+"]").parent().html('<input type="hidden" class="arrowid" value="'+d.id+'"><svg preserveaspectratio="none" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 0L20 '+u/2+"L"+o+" "+u/2+"L"+o+" "+a+'" stroke="#C5CCD0" stroke-width="2px"/><path d="M'+(o-5)+" "+(a-5)+"H"+(o+5)+"L"+o+" "+a+"L"+(o-5)+" "+(a-5)+'Z" fill="#C5CCD0"/></svg>'))}}}c.append("<div class='indicator invisible'></div>"),flowy.import=function(e){c.html(JSON.parse(e.html)),s=e.blockarr},flowy.output=function(){var e={html:JSON.stringify(c.html()),blockarr:s,blocks:[]};if(s.length>0){for(var t=0;t<s.length;t++)e.blocks.push({id:s[t].id,parent:s[t].parent,data:[]}),$(".blockid[value="+s[t].id+"]").parent().children("input").each(function(){var i=$(this).attr("name"),l=$(this).val();e.blocks[t].data.push({name:i,value:l})});return e}},flowy.deleteBlocks=function(){s=[],c.html("<div class='indicator invisible'></div>")},$(document).on("mousedown",".create-flowy",function(e){var i;1===e.which&&(n=$(this),0==s.length?($(this).clone().addClass("block").append("<input type='hidden' name='blockid' class='blockid' value='"+s.length+"'>").removeClass("create-flowy").appendTo("body"),$(this).addClass("dragnow"),l=$(".blockid[value="+s.length+"]").parent()):($(this).clone().addClass("block").append("<input type='hidden' name='blockid' class='blockid' value='"+(Math.max.apply(Math,s.map(e=>e.id))+1)+"'>").removeClass("create-flowy").appendTo("body"),$(this).addClass("dragnow"),l=$(".blockid[value="+(parseInt(Math.max.apply(Math,s.map(e=>e.id)))+1)+"]").parent()),i=$(this),t(i),l.addClass("dragging"),h=!0,o=e.clientX-$(this).offset().left,a=e.clientY-$(this).offset().top,l.css("left",e.clientX-o+"px"),l.css("top",e.clientY-a+"px"))}),$(document).on("mouseup",function(e){if(1===e.which&&(h||x))if(i(),$(".indicator").hasClass("invisible")||$(".indicator").addClass("invisible"),h&&(n.removeClass("dragnow"),l.removeClass("dragging")),0==parseInt(l.children(".blockid").val())&&x){l.removeClass("dragging"),x=!1;for(var t=0;t<p.length;t++)p[t].id!=parseInt(l.children(".blockid").val())&&($(".blockid[value="+p[t].id+"]").parent().css("left",$(".blockid[value="+p[t].id+"]").parent().offset().left-c.offset().left+c.scrollLeft()),$(".blockid[value="+p[t].id+"]").parent().css("top",$(".blockid[value="+p[t].id+"]").parent().offset().top-c.offset().top+c.scrollTop()),$(".arrowid[value="+p[t].id+"]").parent().css("left",$(".arrowid[value="+p[t].id+"]").parent().offset().left-c.offset().left+c.scrollLeft()),$(".arrowid[value="+p[t].id+"]").parent().css("top",$(".arrowid[value="+p[t].id+"]").parent().offset().top-c.offset().top+c.scrollTop()+"px"),$(".blockid[value="+p[t].id+"]").parent().appendTo(c),$(".arrowid[value="+p[t].id+"]").parent().appendTo(c),p[t].x=$(".blockid[value="+p[t].id+"]").parent().offset().left+$(".blockid[value="+p[t].id+"]").innerWidth()/2+c.scrollLeft(),p[t].y=$(".blockid[value="+p[t].id+"]").parent().offset().top+$(".blockid[value="+p[t].id+"]").parent().innerHeight()/2+c.scrollTop());p.filter(e=>0==e.id)[0].x=l.offset().left+l.innerWidth()/2,p.filter(e=>0==e.id)[0].y=l.offset().top+l.innerHeight()/2,s=$.merge(s,p),p=[]}else if(h&&0==s.length&&l.offset().top>c.offset().top&&l.offset().left>c.offset().left)f(l,!0),h=!1,l.css("top",l.offset().top-c.offset().top+c.scrollTop()+"px"),l.css("left",l.offset().left-c.offset().left+c.scrollLeft()+"px"),l.appendTo(c),s.push({parent:-1,childwidth:0,id:parseInt(l.children(".blockid").val()),x:l.offset().left+l.innerWidth()/2+c.scrollLeft(),y:l.offset().top+l.innerHeight()/2+c.scrollTop(),width:l.innerWidth(),height:l.innerHeight()});else if(h&&0==s.length)l.remove();else if(h||x)for(var r=l.offset().left+l.innerWidth()/2+c.scrollLeft(),d=l.offset().top+c.scrollTop(),o=s.map(e=>e.id),a=0;a<s.length;a++){if(r>=s.filter(e=>e.id==o[a])[0].x-s.filter(e=>e.id==o[a])[0].width/2-v&&r<=s.filter(e=>e.id==o[a])[0].x+s.filter(e=>e.id==o[a])[0].width/2+v&&d>=s.filter(e=>e.id==o[a])[0].y-s.filter(e=>e.id==o[a])[0].height/2&&d<=s.filter(e=>e.id==o[a])[0].y+s.filter(e=>e.id==o[a])[0].height){h=!1,!x&&f(l,!1)?k(l,a,o):x&&k(l,a,o);break}a==s.length-1&&(x&&(x=!1,p=[]),h=!1,l.remove())}}),$(document).on("mousedown",".block",function(e){$(document).on("mouseup mousemove",".block",function e(t){if("mouseup"!==t.type&&1===t.which&&!h&&!x){x=!0,(l=$(this)).addClass("dragging"),o=t.clientX-$(this).offset().left,a=t.clientY-$(this).offset().top;var i=parseInt($(this).children(".blockid").val());l=$(this),p.push(s.filter(e=>e.id==i)[0]),s=$.grep(s,function(e){return e.id!=i}),$(".arrowid[value="+i+"]").parent().remove();for(var r=s.filter(e=>e.parent==i),d=!1,f=[],n=[];!d;){for(var v=0;v<r.length;v++)p.push(s.filter(e=>e.id==r[v].id)[0]),$(".blockid[value="+r[v].id+"]").parent().css("left",$(".blockid[value="+r[v].id+"]").parent().offset().left-l.offset().left),$(".blockid[value="+r[v].id+"]").parent().css("top",$(".blockid[value="+r[v].id+"]").parent().offset().top-l.offset().top),$(".arrowid[value="+r[v].id+"]").parent().css("left",$(".arrowid[value="+r[v].id+"]").parent().offset().left-l.offset().left),$(".arrowid[value="+r[v].id+"]").parent().css("top",$(".arrowid[value="+r[v].id+"]").parent().offset().top-l.offset().top),$(".blockid[value="+r[v].id+"]").parent().appendTo(l),$(".arrowid[value="+r[v].id+"]").parent().appendTo(l),f.push(r[v].id),n.push(r[v].id);0==f.length?d=!0:(r=s.filter(e=>f.includes(e.parent)),f=[])}for(v=0;v<s.filter(e=>e.parent==i).length;v++){var u=s.filter(e=>e.parent==i)[v];s=$.grep(s,function(e){return e.id!=u})}for(v=0;v<n.length;v++){u=n[v];s=$.grep(s,function(e){return e.id!=u})}s.length>1&&m(),b&&function(){if(g<c.offset().left){b=!1;for(var e=s.map(e=>e.id),t=0;t<s.length;t++)if($(".blockid[value="+s.filter(i=>i.id==e[t])[0].id+"]").parent().css("left",s.filter(i=>i.id==e[t])[0].x-s.filter(i=>i.id==e[t])[0].width/2-g-20),s.filter(i=>i.id==e[t])[0].x=$(".blockid[value="+s.filter(i=>i.id==e[t])[0].id+"]").parent().offset().left+s.filter(i=>i.id==e[t])[0].width/2,-1!=s.filter(i=>i.id==e[t])[0].parent){var i=s.filter(i=>i.id==e[t])[0],l=i.x-s.filter(i=>i.id==s.filter(i=>i.id==e[t])[0].parent)[0].x;l<0?$(".arrowid[value="+e[t]+"]").parent().css("left",i.x-5-c.offset().left+"px"):$(".arrowid[value="+e[t]+"]").parent().css("left",s.filter(i=>i.id==s.filter(i=>i.id==e[t])[0].parent)[0].x-20-c.offset().left+"px")}for(var t=0;t<s.length;t++);g=0}}()}$(document).off("mouseup mousemove",e)})}),$(document).on("mousemove",function(e){if(h?(l.css("left",e.clientX-o+"px"),l.css("top",e.clientY-a+"px")):x&&(l.css("left",e.clientX-o-c.offset().left+c.scrollLeft()+"px"),l.css("top",e.clientY-a-c.offset().top+c.scrollTop()+"px"),p.filter(e=>e.id==parseInt(l.children(".blockid").val())).x=l.offset().left+l.innerWidth()/2+c.scrollLeft(),p.filter(e=>e.id==parseInt(l.children(".blockid").val())).y=l.offset().left+l.innerHeight()/2+c.scrollTop()),h||x)for(var t=l.offset().left+l.innerWidth()/2+c.scrollLeft(),i=l.offset().top+c.scrollTop(),r=s.map(e=>e.id),d=0;d<s.length;d++){if(t>=s.filter(e=>e.id==r[d])[0].x-s.filter(e=>e.id==r[d])[0].width/2-v&&t<=s.filter(e=>e.id==r[d])[0].x+s.filter(e=>e.id==r[d])[0].width/2+v&&i>=s.filter(e=>e.id==r[d])[0].y-s.filter(e=>e.id==r[d])[0].height/2&&i<=s.filter(e=>e.id==r[d])[0].y+s.filter(e=>e.id==r[d])[0].height){$(".indicator").appendTo($(".blockid[value="+r[d]+"]").parent()),$(".indicator").css("left",$(".blockid[value="+r[d]+"]").parent().innerWidth()/2-5+"px"),$(".indicator").css("top",$(".blockid[value="+r[d]+"]").parent().innerHeight()+"px"),$(".indicator").removeClass("invisible");break}d==s.length-1&&($(".indicator").hasClass("invisible")||$(".indicator").addClass("invisible"))}})})};